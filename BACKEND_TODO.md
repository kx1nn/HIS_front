# 后端开发任务清单 (Backend Todo List)

本文档基于前端现有逻辑及“挂号即收费”等业务需求，整理了后端需要完善的功能点。

## 1. 挂号模块 (Registration) - 核心变更

**目标**：实现“挂号即收费”模式，减少患者排队次数，闭环财务流程。

- [ ] **修改挂号提交接口** (`POST /api/nurse/registrations`)
  - **入参扩展**：增加 `paymentMethod` (支付方式: 1=现金, 3=微信, 4=支付宝) 和 `transactionNo` (流水号) 字段。
  - **事务处理**：
    1. 创建 `Registration` 记录（状态：待诊）。
    2. **同步创建** `Charge` 记录：
       - `type`: `REGISTRATION` (挂号费)
       - `amount`: 根据医生/科室配置的挂号费 (如 20 元)
       - `status`: `1` (已支付)
       - `paymentMethod`: 使用入参中的支付方式
    3. 关联二者：确保 `Charge` 记录关联到该 `Registration` ID。
- [ ] **完善退号接口** (`PUT /registrations/{id}/cancel`)
  - **逻辑增强**：当取消挂号时，自动检查是否存在关联的“挂号费”收费单。
  - **自动退费**：如果存在且已支付，自动触发退费逻辑（生成负数金额的流水或标记为已退费），并更新财务统计。

## 2. 药房工作台 (Pharmacy Station) - 药品展示与管理

**目标**：提供更详尽的药品信息，支持药师快速审核与发药。

- [ ] **增强药品搜索接口** (`GET /common/medicines/search`)
  - **返回字段补全**：确保返回完整的药品详情，前端展示需要以下字段：
    - `stock` (当前库存)
    - `unit` (单位，如：盒/瓶)
    - `specification` (规格，如：0.25g\*12 粒)
    - `manufacturer` (生产厂家)
    - `price` (单价)
    - `batchNumber` (批号)
    - `expiryDate` (有效期)
    - `pinyinCode` (拼音码，用于前端快速检索)
- [ ] **待发药处方接口优化** (`GET /medicine/pending`)
  - **数据聚合**：返回的处方列表中，除了药品名称，建议直接包含 `stock` (当前库存) 和 `location` (货架号)，方便药师快速拿药。
  - **状态标记**：如果某药品库存不足，在返回数据中增加 `isLowStock: true` 标记，前端可高亮预警。
- [ ] **新增/完善库存预警接口**
  - **效期预警**：建议新增 `GET /medicine/expiry-alerts`，由后端筛选“3 个月内过期”的药品，而不是把所有药品拉到前端计算。
  - **低库存预警**：建议新增 `GET /medicine/low-stock-alerts`，返回库存低于阈值的药品列表。

## 3. 收费管理 (Charge Management)

**目标**：统一管理挂号费、诊疗费和药费。

- [ ] **收费列表接口适配** (`GET /api/cashier/charges`)
  - **类型筛选**：支持按 `type` 筛选（如：只看挂号费、只看药费）。
  - **数据包含**：确保该接口能返回由“挂号接口”自动生成的挂号费记录，以便财务核对。
- [ ] **收费单创建接口** (`POST /api/cashier/charges`)
  - **逻辑确认**：确认该接口目前仅用于“处方/诊疗项目”的收费。如果未来需要支持“补交挂号费”，需要预留逻辑。

## 4. 医生工作台 (Doctor Station)

**目标**：防止开出无货药品。

- [ ] **处方开立校验** (`POST /prescriptions`)
  - **库存校验**：医生提交处方时，后端应检查药品库存。如果库存不足，返回明确的错误码和提示信息（如：“阿莫西林库存不足，剩余 2 盒”），阻止处方生成。

## 5. 管理员/统计 (Admin & Statistics)

- [ ] **每日营收统计** (`GET /api/cashier/charges/statistics/daily`)
  - **数据聚合**：确保统计金额时，包含了“挂号费”这一项收入。建议返回结构中将“挂号收入”和“药品收入”分列展示。
